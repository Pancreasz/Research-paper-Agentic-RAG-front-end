name: Build and Deploy Locally

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    # CRITICAL CHANGE: This tells GitHub to use YOUR computer, not their cloud servers
    runs-on: self-hosted 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Login to Docker (Use secrets if you want, or just log in manually on your PC once)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 2. Build the image directly on your PC
      - name: Build Docker Image
        shell: cmd
        run: docker build -t rag-frontend:latest .

      # 3. Stop old container and run new one (Directly on your PC)
      - name: Deploy
        run: |
          # PowerShell way to ignore errors if container doesn't exist
          try { docker stop rag-frontend } catch {}
          try { docker rm rag-frontend } catch {}
          
          # Run the new container
          docker run -d --name rag-frontend -p 80:80 rag-frontend:latest